#FROM instructure/rvm:latest
#FROM adgud2/ruby-rvm:latest
#FROM hypriot/rpi-ruby:latest
#FROM resin/rpi-raspbian
FROM resin/armv7hf-debian
#FROM armhf/ubuntu
#FROM tzenderman/docker-rvm
#FROM hypriot/rpi-ruby:latest
#FROM jrobertson/rpi-rvm:latest

MAINTAINER Thiago Soares <thiagosoarescruz0@gmail.com>

#RUN [ "cross-build-start" ]

RUN useradd -m docker && echo "docker:docker" | chpasswd && adduser docker sudo

#USER docker
#RUN docker ALL = NOPASSWD: /sbin/poweroff, /sbin/start, /sbin/stop

#RUN curl -s https://packagecloud.io/install/repositories/Hypriot/Schatzkiste/script.deb.sh.deb | sudo bash
#RUN sudo apt-get install docker-hypriot=1.11.1-1

#FROM hypriot/image-builder

# Install MySQL client
RUN apt-get update -yq
RUN apt-get install -y mysql-client
RUN apt-get autoremove -y
RUN rm -rf /var/lib/apt/lists/*

# Install Build essentials
RUN apt-get update -yq
RUN apt-get -qy install ca-certificates
RUN apt-get install -y build-essential
RUN apt-get install -y libpq-dev
RUN apt-get install -y nodejs-legacy
RUN apt-get autoremove -y

RUN apt-get install patch
RUN apt-get install ruby-dev
RUN apt-get install zlib1g-dev
RUN apt-get install liblzma-dev

RUN apt-get install liblzma-dev
RUN sudo apt-get install autoconf bison build-essential libssl-dev libyaml-dev libreadline6-dev zlib1g-dev libncurses5-dev libffi-dev libgdbm3 libgdbm-dev

RUN rm -rf /var/lib/apt/lists/*

###### Testes do RVM

#RUN echo "deb http://archive.ubuntu.com/ubuntu raring main universe" > /etc/apt/sources.list

# install RVM, Ruby, and Bundler
#RUN \curl -L https://get.rvm.io | bash -s stable

RUN \curl -sSL https://get.rvm.io | bash -s stable --without-gems="rvm rubygems-bundler"
RUN /bin/bash -l -c "rvm requirements"
RUN /bin/bash -l -c "rvm install 2.3.3"
RUN /bin/bash -l -c "gem install bundler --no-ri --no-rdoc"

RUN /bin/bash -l -c "apt-get install rubygems"
#RUN /bin/bash -l -c "gem update --system"
RUN /bin/bash -l -c "gem install rails"
RUN /bin/bash -l -c "gem install bundler"


#RUN sudo apt-get install rubygems
#RUN sudo gem install rails
#RUN sudo apt-get install gem -y
#RUN sudo gem update --system
#RUN sudo apt-get install ruby-full
#RUN sudo gem install bundler

#FROM tzenderman/docker-rvm
#RUN `\curl -sSL https://raw.githubusercontent.com/wayneeseguin/rvm/stable/binscripts/rvm-installer | sudo bash -s stable`
#RUN curl -sSL https://get.rvm.io | bash -s stable
#RUN sudo apt-get install rubygems
#RUN sudo apt-get install gem -y
#RUN sudo gem update --system
#RUN sudo gem install bundle

#RUN curl -L get.rvm.io | bash -s stable --rails
#RUN curl -sSL https://get.rvm.io | bash -s stable --ruby
#RUN curl -sSL https://get.rvm.io | bash -s stable --without-gems="rvm rubygems-bundler"
                                                                                42,1          39%
#RUN curl -sSL https://get.rvm.io | bash -s stable --ruby
#RUN curl -sSL https://get.rvm.io | bash -s stable --without-gems="rvm rubygems-bundler"
#RUN `\curl -sSL https://get.rvm.io | bash -s stable`
#RUN `\curl -sSL https://raw.githubusercontent.com/wayneeseguin/rvm/stable/binscripts/rvm-installer | sudo bash -s stable`


######

# Workdir
RUN mkdir -p /home/app


#FROM hypriot/rpi-ruby:latest
# Install rvm, default ruby version and bundler.

# Install gems
ADD Gemfile* /home/app/

#Add Docker path
ADD docker /home/app/docker/

# Add the Rails app
ADD . /home/app

WORKDIR /home/app

#Instalar Ruby por script
#CMD "docker/install_ruby.sh"

# Set some config
ENV RAILS_LOG_TO_STDOUT true

#Add sidekiq pid
#ADD sidekiq.pid /home/app/tmp/pids/

#Run bundler
#RUN bundler install
RUN /bin/bash -l -c "bundler install"

RUN bundle update

#RUN bash docker/bundle.sh

# Add the Rails app
#ADD . /home/app

# Create user and group
RUN groupadd --gid 9999 app
RUN useradd --uid 9999 --gid app app
RUN chown -R app:app /home/app

# Expose app port
EXPOSE 80 3000

# Save timestamp of image building
#RUN date -u > BUILD_TIME

# Start up
#CMD "docker/startup.sh"

#RUN [ "cross-build-end" ]